@page "/registrar-venta"
@inject WEBAPP.Services.VentaService VentaService
@inject WEBAPP.Services.ProductoService ProductoService
@inject WEBAPP.Services.AuthState State
@inject NavigationManager Nav

<PageTitle>Registro de Ventas</PageTitle>

@if (!State.IsInRole("Admin", "Operador"))
{
    <div class="alert alert-danger">No tienes permisos para acceder a esta sección.</div>
}
else
{
    <!-- Notificación Toast -->
    @if (showNotification)
    {
        <div class="toast-notification">
            <div class="toast show @(notificationType == "success" ? "toast-success" : "toast-error")">
                <div class="toast-header @(notificationType == "success" ? "bg-success" : "bg-danger") text-white">
                    <strong class="me-auto">@(notificationType == "success" ? "? Éxito" : "? Error")</strong>
                    <button type="button" class="btn-close btn-close-white" @onclick="() => showNotification = false"></button>
                </div>
                <div class="toast-body">
                    @notificationMessage
                </div>
            </div>
        </div>
    }

    <h4 class="page-title">Registro de ventas</h4>

    @if (isLoading)
    {
        <div class="text-center py-4">
            <div class="spinner-border" style="color: var(--primary-red);" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
    }
    else
    {
        <!-- Formulario de agregar producto -->
        <div class="row g-3 align-items-end mb-4">
            <div class="col-md-2">
                <label class="form-label">Codigo:</label>
                <input class="form-control" @bind="searchCodigo" @bind:event="oninput" placeholder="001" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Producto:</label>
                <select class="form-control" @bind="selectedProductoId" @bind:after="OnProductoSelected">
                    <option value="0">Seleccione...</option>
                    @foreach (var p in productos)
                    {
                        <option value="@p.Id">@p.Nombre</option>
                    }
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Precio</label>
                <input class="form-control" type="number" step="0.01" @bind="inputPrecio" readonly />
            </div>
            <div class="col-md-2">
                <label class="form-label">Cantidad</label>
                <input class="form-control" type="number" min="1" @bind="inputCantidad" />
            </div>
            <div class="col-md-3">
                <button class="btn btn-add-product" @onclick="AgregarProducto">
                    + agregar producto
                </button>
            </div>
        </div>

        <!-- Detalle de ventas -->
        <div class="mb-3">
            <strong>Detalle de ventas (Vendedor: @State.Username)</strong>
        </div>

        <table class="table-custom">
            <thead>
                <tr>
                    <th style="width: 50px;">N°</th>
                    <th style="width: 80px;">Codigo</th>
                    <th style="width: 120px;">Fecha</th>
                    <th>Producto</th>
                    <th style="width: 80px;">Precio</th>
                    <th style="width: 80px;">Cantidad</th>
                    <th style="width: 80px;">Total</th>
                    <th style="width: 60px;">quitar</th>
                </tr>
            </thead>
            <tbody>
                @if (formDetalles.Count == 0)
                {
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            No hay productos agregados. Use el formulario superior para agregar.
                        </td>
                    </tr>
                }
                else
                {
                    @for (int i = 0; i < formDetalles.Count; i++)
                    {
                        var index = i;
                        var det = formDetalles[index];
                        var prod = productos.FirstOrDefault(p => p.Id == det.Idpro);
                        <tr>
                            <td>@(index + 1)</td>
                            <td>@(prod?.Codigo ?? "---")</td>
                            <td>@DateTime.Now.ToString("yyyy-MM-dd")</td>
                            <td>@(prod?.Nombre ?? "Producto")</td>
                            <td>@det.Precio.ToString("F2")</td>
                            <td>@det.Cantidad</td>
                            <td>@((det.Cantidad * det.Precio).ToString("F2"))</td>
                            <td>
                                <button class="btn-delete" @onclick="() => RemoveDetalle(index)" title="Quitar">
                                    <span class="icon-trash"></span>
                                </button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>

        <!-- Totales -->
        <div class="totals-section">
            <div class="total-row">
                <span class="total-label">Sub total:</span>
                <span class="total-value">@CalcularSubtotal().ToString("F2")</span>
            </div>
            <div class="total-row">
                <span class="total-label">Total con IVA:</span>
                <span class="total-value">@CalcularIvaTotal().ToString("F2")</span>
            </div>
            <div class="total-row total-final">
                <span class="total-label">Total a pagar:</span>
                <span class="total-value">@CalcularTotalGeneral().ToString("F2")</span>
            </div>
        </div>

        <!-- Botón registrar -->
        <div class="mt-4">
            <button class="btn-register" @onclick="GuardarVenta" disabled="@isSaving">
                @if (isSaving)
                {
                    <span class="spinner-border spinner-border-sm me-2"></span>
                }
                Registrar venta
            </button>
        </div>
    }
}

@code {
    private List<WEBAPP.Models.Producto> productos = new();
    private bool isLoading = true;

    // Input fields for adding products
    private string searchCodigo = string.Empty;
    private int selectedProductoId;
    private decimal inputPrecio;
    private int inputCantidad = 1;

    // Form state
    private List<DetalleForm> formDetalles = new();
    private bool isSaving;

    // Notification
    private bool showNotification;
    private string notificationMessage = string.Empty;
    private string notificationType = "success";

    private class DetalleForm
    {
        public int Idpro { get; set; }
        public int Cantidad { get; set; } = 1;
        public decimal Precio { get; set; }
        public decimal Iva { get; set; }
        public decimal Total { get; set; }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadData();
            StateHasChanged();
        }
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            var productosResult = await ProductoService.GetAllAsync();
            productos = productosResult.Data;
        }
        catch (Exception ex)
        {
            ShowNotification("Error al cargar datos: " + ex.Message, "error");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ShowNotification(string message, string type = "success")
    {
        notificationMessage = message;
        notificationType = type;
        showNotification = true;
        _ = HideNotificationAfterDelay();
    }

    private async Task HideNotificationAfterDelay()
    {
        await Task.Delay(4000);
        showNotification = false;
        StateHasChanged();
    }

    private void OnProductoSelected()
    {
        var producto = productos.FirstOrDefault(p => p.Id == selectedProductoId);
        if (producto is not null)
        {
            inputPrecio = producto.Precio;
            searchCodigo = producto.Codigo;
        }
        else
        {
            inputPrecio = 0;
        }
    }

    private void AgregarProducto()
    {
        if (selectedProductoId == 0)
        {
            ShowNotification("Seleccione un producto.", "error");
            return;
        }

        if (inputCantidad <= 0)
        {
            ShowNotification("La cantidad debe ser mayor a 0.", "error");
            return;
        }

        var subtotal = inputCantidad * inputPrecio;
        var iva = Math.Round(subtotal * 0.13m, 2);
        var total = subtotal + iva;

        formDetalles.Add(new DetalleForm
        {
            Idpro = selectedProductoId,
            Cantidad = inputCantidad,
            Precio = inputPrecio,
            Iva = iva,
            Total = total
        });

        // Reset inputs
        selectedProductoId = 0;
        inputPrecio = 0;
        inputCantidad = 1;
        searchCodigo = string.Empty;
    }

    private void RemoveDetalle(int index)
    {
        if (index >= 0 && index < formDetalles.Count)
            formDetalles.RemoveAt(index);
    }

    private decimal CalcularSubtotal() => formDetalles.Sum(d => d.Cantidad * d.Precio);
    private decimal CalcularIvaTotal() => formDetalles.Sum(d => d.Iva);
    private decimal CalcularTotalGeneral() => formDetalles.Sum(d => d.Total);

    private async Task GuardarVenta()
    {
        if (formDetalles.Count == 0)
        {
            ShowNotification("Debe agregar al menos un producto.", "error");
            return;
        }

        isSaving = true;
        try
        {
            var request = new WEBAPP.Models.VentaRequest
            {
                Fecha = DateTime.Now,
                Vendedor = State.Username ?? "Operador",
                Total = CalcularTotalGeneral(),
                Detalles = formDetalles
                    .Select(d => new WEBAPP.Models.DetalleVentaRequest
                    {
                        Fecha = DateTime.Now,
                        Idpro = d.Idpro,
                        Cantidad = d.Cantidad,
                        Precio = d.Precio,
                        Iva = d.Iva,
                        Total = d.Total
                    }).ToList()
            };

            var (success, message, id) = await VentaService.CreateAsync(request);
            if (success)
            {
                ShowNotification($"¡Venta registrada exitosamente! ID: {id}");
                formDetalles = new();
            }
            else
            {
                ShowNotification(message, "error");
            }
        }
        catch (Exception ex)
        {
            ShowNotification("Error: " + ex.Message, "error");
        }
        finally
        {
            isSaving = false;
        }
    }
}
